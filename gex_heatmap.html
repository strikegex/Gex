<!DOCTYPE html>
<!-- saved from url=(0048)file:///Users/kevin/Downloads/gex_heatmap_2.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GEX Heatmap + Strategy</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#08080d;--panel:#0e0e16;--card:#12121c;--border:#1a1a2a;--text:#b8b8cc;--dim:#555570;--bright:#e8e8f4;--yellow:#fbbf24;--purple:#a855f7;--green:#22c55e;--king:#f59e0b;--accent:#6366f1;--red:#ef4444;--cyan:#06b6d4}
body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;min-height:100vh}

.hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 24px;border-bottom:1px solid var(--border);background:var(--panel)}
.hdr h1{font-family:'Space Grotesk',sans-serif;font-size:18px;font-weight:700;color:var(--bright);letter-spacing:-.5px}
.hdr h1 em{font-style:normal;color:var(--accent)}
.hdr-r{display:flex;gap:10px;align-items:center}
.hdr-r a{font-size:10px;color:var(--accent);text-decoration:none;padding:4px 10px;border:1px solid var(--border);border-radius:4px}
.hdr-r a:hover{background:var(--accent);color:#fff}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--red)}
.status-dot.live{background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.status-text{font-size:10px;color:var(--dim)}

.ctrl{display:flex;gap:10px;padding:10px 24px;border-bottom:1px solid var(--border);background:var(--panel);flex-wrap:wrap;align-items:center}
button,select{font-family:'JetBrains Mono',monospace;font-size:11px;background:var(--card);color:var(--text);border:1px solid var(--border);padding:5px 10px;border-radius:4px;cursor:pointer;transition:all .15s}
button:hover{background:var(--border);color:var(--bright);border-color:var(--accent)}
.ctrl label{font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px}
.ctrl-g{display:flex;align-items:center;gap:6px}

.legend{display:flex;gap:14px;padding:5px 24px;border-bottom:1px solid var(--border);background:var(--panel);flex-wrap:wrap;align-items:center}
.legend-t{font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px}
.legend-i{display:flex;align-items:center;gap:4px;font-size:9px}
.lsw{width:11px;height:11px;border-radius:2px;flex-shrink:0}
.lsw.y{background:var(--yellow)}.lsw.p{background:var(--purple)}.lsw.g{background:var(--green)}
.lsw.k{background:linear-gradient(135deg,var(--king),#fde68a);position:relative}
.lsw.k::after{content:"‚òÖ";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:7px;color:#000}
.legend-d{color:var(--dim);font-size:8px}

.sample-banner{display:none;padding:5px 24px;background:rgba(251,191,36,.06);border-bottom:1px solid rgba(251,191,36,.15);font-size:10px;color:var(--yellow);text-align:center}
.sample-banner.vis{display:block}

/* ‚îÄ‚îÄ‚îÄ Rec Cards ‚îÄ‚îÄ‚îÄ */
.rec-wrap{display:none;padding:12px 24px;gap:10px;flex-wrap:wrap;border-bottom:1px solid var(--border)}
.rec-wrap.vis{display:flex}
.rec{flex:1;min-width:280px;background:var(--card);border:1px solid var(--border);border-radius:6px;padding:12px 14px;position:relative;overflow:hidden}
.rec::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.rec.range::before{background:var(--yellow)}.rec.trend::before{background:var(--purple)}.rec.chop::before{background:var(--green)}
.rec-sym{font-family:'Space Grotesk',sans-serif;font-size:14px;font-weight:700;color:var(--bright);display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.rec-badge{font-size:8px;padding:2px 6px;border-radius:3px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.rec-badge.range{background:rgba(251,191,36,.12);color:var(--yellow);border:1px solid rgba(251,191,36,.2)}
.rec-badge.trend{background:rgba(168,85,247,.12);color:var(--purple);border:1px solid rgba(168,85,247,.2)}
.rec-badge.chop{background:rgba(34,197,94,.12);color:var(--green);border:1px solid rgba(34,197,94,.2)}
.rec-sum{font-size:10px;color:var(--bright);line-height:1.6;margin-bottom:8px;padding:6px 8px;background:rgba(255,255,255,.02);border-radius:4px;border-left:3px solid var(--accent)}
.rec-act{font-size:9px;padding:2px 0;display:flex;align-items:baseline;gap:5px;color:var(--text)}
.rec-lvls{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
.rec-lv{font-size:8px;padding:2px 6px;border-radius:3px}
.rec-lv.king{background:rgba(245,158,11,.12);color:var(--king);border:1px solid rgba(245,158,11,.25)}
.rec-lv.rng{background:rgba(99,102,241,.08);color:var(--accent);border:1px solid rgba(99,102,241,.2)}

/* ‚ïê‚ïê‚ïê STRATEGY PANEL ‚ïê‚ïê‚ïê */
.strat-wrap{display:none;padding:12px 24px;gap:10px;flex-wrap:wrap;border-bottom:1px solid var(--border)}
.strat-wrap.vis{display:flex}
.strat-card{flex:1;min-width:280px;max-width:480px;background:var(--card);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.strat-hdr{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.strat-sym{font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:700;color:var(--bright)}
.strat-type-badge{font-size:9px;padding:3px 8px;border-radius:4px;font-weight:600;letter-spacing:.3px}
.strat-type-badge.ic{background:rgba(251,191,36,.12);color:var(--yellow);border:1px solid rgba(251,191,36,.25)}
.strat-type-badge.cs{background:rgba(168,85,247,.12);color:var(--purple);border:1px solid rgba(168,85,247,.25)}
.strat-type-badge.bf{background:rgba(6,182,212,.12);color:var(--cyan);border:1px solid rgba(6,182,212,.25)}
.strat-type-badge.ds{background:rgba(34,197,94,.12);color:var(--green);border:1px solid rgba(34,197,94,.25)}
.strat-type-badge.dg{background:rgba(239,68,68,.12);color:var(--red);border:1px solid rgba(239,68,68,.25)}

.strat-body{padding:14px 16px}
.strat-name{font-family:'Space Grotesk',sans-serif;font-size:16px;font-weight:700;color:var(--bright);margin-bottom:4px}
.strat-rationale{font-size:10px;color:var(--text);line-height:1.7;margin-bottom:12px;padding:8px 10px;background:rgba(255,255,255,.02);border-radius:4px;border-left:3px solid var(--king)}

.strat-legs{margin-bottom:12px}
.strat-legs-title{font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.strat-leg{display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(255,255,255,.02);border-radius:4px;margin-bottom:3px;font-size:11px}
.strat-leg-action{font-weight:700;width:40px;text-align:center;padding:2px 0;border-radius:3px;font-size:9px}
.strat-leg-action.sell{background:rgba(239,68,68,.15);color:var(--red)}
.strat-leg-action.buy{background:rgba(34,197,94,.15);color:var(--green)}
.strat-leg-type{color:var(--dim);width:40px}
.strat-leg-strike{color:var(--bright);font-weight:600;flex:1}
.strat-leg-tag{font-size:8px;padding:1px 5px;border-radius:3px}
.strat-leg-tag.gw{background:rgba(251,191,36,.1);color:var(--yellow)}
.strat-leg-tag.pw{background:rgba(168,85,247,.1);color:var(--purple)}
.strat-leg-tag.kn{background:rgba(245,158,11,.1);color:var(--king)}
.strat-leg-tag.sp{background:rgba(255,255,255,.06);color:var(--dim)}

.strat-details{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.strat-detail{background:rgba(255,255,255,.02);border-radius:4px;padding:8px 10px;text-align:center}
.strat-detail-label{font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.strat-detail-val{font-size:13px;font-weight:600;color:var(--bright)}
.strat-detail-val.profit{color:var(--green)}
.strat-detail-val.risk{color:var(--red)}

.strat-why{font-size:9px;color:var(--dim);line-height:1.6;padding:8px 10px;background:rgba(255,255,255,.015);border-radius:4px;border:1px solid var(--border)}
.strat-why strong{color:var(--text)}
.strat-why em{font-style:normal;color:var(--yellow)}
.strat-why .pur{color:var(--purple)}

.strat-disclaimer{font-size:8px;color:var(--dim);padding:8px 16px;border-top:1px solid var(--border);text-align:center;letter-spacing:.3px}

/* ‚îÄ‚îÄ‚îÄ Heatmap ‚îÄ‚îÄ‚îÄ */
.hm-wrap{display:flex;gap:2px;padding:12px 24px;overflow-x:auto;min-height:calc(100vh - 340px)}
.panel{flex:1;min-width:300px;max-width:500px;background:var(--panel);border:1px solid var(--border);border-radius:6px;overflow:hidden;display:flex;flex-direction:column}
.panel-hdr{display:flex;justify-content:space-between;align-items:baseline;padding:10px 14px 6px;border-bottom:1px solid var(--border)}
.panel-sym{font-family:'Space Grotesk',sans-serif;font-size:14px;font-weight:700;color:var(--bright)}
.panel-price{font-size:14px;font-weight:600;color:var(--bright)}
.panel-sub{display:flex;justify-content:space-between;padding:3px 14px 5px;border-bottom:1px solid var(--border)}
.panel-sub span{font-size:9px;color:var(--dim)}
.panel-gp{padding:4px 14px;border-bottom:1px solid var(--border);font-size:10px;display:flex;justify-content:space-between;align-items:center}
.gbadge{padding:2px 6px;border-radius:3px;font-size:8px;font-weight:600}
.gbadge.pos{background:rgba(251,191,36,.12);color:var(--yellow)}.gbadge.neg{background:rgba(168,85,247,.12);color:var(--purple)}.gbadge.neu{background:rgba(34,197,94,.12);color:var(--green)}
.klevels{display:flex;gap:5px;padding:4px 14px 5px;border-bottom:1px solid var(--border);flex-wrap:wrap}
.klev{font-size:7px;padding:2px 5px;border-radius:3px;text-transform:uppercase;letter-spacing:.3px}
.klev.gw{background:rgba(251,191,36,.1);color:var(--yellow);border:1px solid rgba(251,191,36,.2)}
.klev.pw{background:rgba(168,85,247,.1);color:var(--purple);border:1px solid rgba(168,85,247,.2)}
.klev.kn{background:rgba(245,158,11,.12);color:var(--king);border:1px solid rgba(245,158,11,.2)}
.klev.sp{background:rgba(255,255,255,.05);color:var(--bright);border:1px solid rgba(255,255,255,.1)}
.strikes{flex:1;overflow-y:auto;padding:2px 0}
.sr{display:flex;align-items:center;height:28px;padding:0 3px;position:relative;cursor:default;transition:background .1s}
.sr:hover{outline:1px solid rgba(255,255,255,.15);z-index:1}
.sr.spot{outline:2px solid #fff;z-index:2}
.sr.king{outline:2px solid var(--king);z-index:3}
.sr-bg{position:absolute;inset:0;opacity:.75;transition:opacity .15s}
.sr:hover .sr-bg{opacity:.9}
.sr-lbl{width:66px;font-size:10px;font-weight:500;text-align:left;padding-left:5px;flex-shrink:0;z-index:1;position:relative;color:var(--text)}
.sr.spot .sr-lbl{color:#fff;font-weight:700}
.sr.spot .sr-lbl::after{content:" ‚ñ∏"}
.sr.king .sr-lbl::before{content:"‚òÖ ";color:var(--king)}
.gbar-c{flex:1;height:100%;position:relative;display:flex;align-items:center;justify-content:flex-end}
.gval{font-size:10px;font-weight:600;position:relative;z-index:1;padding:0 8px;white-space:nowrap}

.tip{display:none;position:fixed;background:#14142a;border:1px solid var(--border);border-radius:6px;padding:10px 14px;font-size:11px;z-index:100;pointer-events:none;box-shadow:0 8px 32px rgba(0,0,0,.6);min-width:240px}
.tip.vis{display:block}
.tip-t{font-weight:600;color:var(--bright);margin-bottom:6px;font-size:12px}
.tip-r{display:flex;justify-content:space-between;gap:14px;margin:3px 0}
.tip-l{color:var(--dim)}.tip-v{color:var(--bright);font-weight:500}
.tip-d{border-top:1px solid var(--border);margin:5px 0}
.tip-b{font-size:9px;color:var(--dim);margin-top:4px;line-height:1.5}
.tip-b strong{color:var(--text)}

.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:50vh;gap:12px;text-align:center;padding:40px}
.empty h2{font-family:'Space Grotesk',sans-serif;font-size:15px;color:var(--bright)}
.empty p{font-size:12px;color:var(--dim);max-width:440px;line-height:1.7}
.empty code{background:var(--card);padding:2px 6px;border-radius:3px;font-size:10px;color:var(--accent)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
</style>
</head>
<body>
<div class="hdr">
  <h1><em>GEX</em> Heatmap + Strategy</h1>
  <div class="hdr-r">
    <a href="file:///Users/kevin/Downloads/gex_history_dashboard.html">üìà History</a>
    <div class="status-dot live" id="sd"></div><span class="status-text" id="st">Updated 11:23:37 AM</span>
  </div>
</div>
<div class="ctrl">
  <div class="ctrl-g"><button onclick="document.getElementById(&#39;fi&#39;).click()">üìÇ Load JSON</button><input type="file" id="fi" accept=".json" style="display:none" onchange="loadFile(event)"></div>
  <div class="ctrl-g"><button onclick="loadSample()">üß™ Sample</button></div>
  <div class="ctrl-g"><button onclick="autoInterval?stopAutoReload():startAutoReload()" id="arBtn">üîÑ Auto-reload</button></div>
  <div class="ctrl-g"><button onclick="toggleStrats()" id="stratBtn">üìä Strategy ‚ñæ</button></div>
  <div class="ctrl-g" style="margin-left:auto"><label>Strikes:</label>
    <select id="ns" onchange="rerender()"><option value="15">15</option><option value="25" selected="">25</option><option value="40">40</option><option value="60">60</option></select>
  </div>
</div>
<div class="legend">
  <span class="legend-t">Heatmap Legend:</span>
  <div class="legend-i"><div class="lsw y"></div><span style="color:var(--yellow)">Yellow (+Gamma)</span></div>
  <div class="legend-i"><div class="lsw p"></div><span style="color:var(--purple)">Purple (‚àíGamma)</span></div>
  <div class="legend-i"><div class="lsw g"></div><span style="color:var(--green)">Green (Neutral)</span></div>
  <div class="legend-i"><div class="lsw k"></div><span style="color:var(--king)">‚òÖ King Node</span></div>
  <button onclick="document.getElementById(&#39;legend-detail&#39;).style.display=document.getElementById(&#39;legend-detail&#39;).style.display===&#39;none&#39;?&#39;block&#39;:&#39;none&#39;" style="margin-left:auto;font-size:9px;padding:3px 8px">? Color Guide</button>
</div>
<div id="legend-detail" style="display:none;padding:14px 24px;border-bottom:1px solid var(--border);background:var(--panel);font-size:10px;line-height:1.8">
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px">
    <div style="background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.15);border-radius:6px;padding:12px 14px">
      <div style="font-size:13px;font-weight:700;color:var(--yellow);margin-bottom:6px">üü° Yellow ‚Äî Positive Gamma (+GEX)</div>
      <div style="color:var(--text)"><strong>What it means:</strong> Dealers are NET SHORT options at this strike. They sold options to customers.</div>
      <div style="color:var(--text);margin-top:4px"><strong>How dealers hedge:</strong> They hedge AGAINST the move. If price rises toward this strike, they sell. If price falls, they buy. This creates <em>mean reversion</em> ‚Äî price snaps back.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Trading behavior:</strong> Price is "sticky" here. Acts as support (below spot) or resistance (above spot). Volatility dampens. Range-bound action.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Strategy implication:</strong> ‚úÖ SELL premium here. Iron condors, credit spreads, butterflies. This is where you want your short strikes ‚Äî dealers defend your position.</div>
    </div>
    <div style="background:rgba(168,85,247,.06);border:1px solid rgba(168,85,247,.15);border-radius:6px;padding:12px 14px">
      <div style="font-size:13px;font-weight:700;color:var(--purple);margin-bottom:6px">üü£ Purple ‚Äî Negative Gamma (‚àíGEX)</div>
      <div style="color:var(--text)"><strong>What it means:</strong> Dealers are NET LONG options at this strike. Customers sold options to dealers.</div>
      <div style="color:var(--text);margin-top:4px"><strong>How dealers hedge:</strong> They hedge WITH the move. If price rises, they buy more. If price falls, they sell more. This creates <em>momentum</em> ‚Äî moves accelerate.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Trading behavior:</strong> Price is "slippery" here. Breakouts/breakdowns carry through. Volatility expands. Trending/momentum action.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Strategy implication:</strong> ‚ö†Ô∏è DO NOT sell premium here. Dealers amplify against you. Instead: buy debit spreads, ride momentum, or stay away. Never place short strikes in purple zones.</div>
    </div>
    <div style="background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.15);border-radius:6px;padding:12px 14px">
      <div style="font-size:13px;font-weight:700;color:var(--green);margin-bottom:6px">üü¢ Green ‚Äî Neutral / Mixed Gamma</div>
      <div style="color:var(--text)"><strong>What it means:</strong> Dealer positioning is roughly balanced at this strike. No strong directional bias from hedging flows.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Trading behavior:</strong> Choppy, indecisive price action. No strong pull in either direction. Low conviction zone.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Strategy implication:</strong> ‚ö™ Reduce size. Wait for a clearer setup. If trading, use iron butterflies at king node with smaller position. Can flip +/‚àí without warning.</div>
    </div>
    <div style="background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.15);border-radius:6px;padding:12px 14px">
      <div style="font-size:13px;font-weight:700;color:var(--king);margin-bottom:6px">‚òÖ King Node ‚Äî Max Absolute Gamma</div>
      <div style="color:var(--text)"><strong>What it means:</strong> The strike with the LARGEST absolute gamma exposure. Where dealers have the most hedging activity.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Trading behavior:</strong> Acts as a <em>price magnet</em>. Spot drifts toward king throughout the session, especially during 0DTE expiration. Think of it as gravity ‚Äî price wants to pin here.</div>
      <div style="color:var(--text);margin-top:4px"><strong>Strategy implication:</strong> ‚òÖ This is your TARGET. Center butterflies here. If king is above spot ‚Üí bullish drift expected. Below ‚Üí bearish drift. At spot ‚Üí pin/chop, perfect for iron condors.</div>
    </div>
  </div>
</div>
<div class="sample-banner" id="sb">‚ö† Sample data</div>

<!-- Recommendations (dynamically populated) -->
<div class="rec-wrap" id="rw"></div>

<!-- Strategy (hidden by default, toggle to show) -->
<div class="strat-wrap" id="sw"></div>

<!-- Tooltip -->
<div class="tip" id="tip"><div class="tip-t" id="tt"></div><div id="tb"></div></div>

<!-- Heatmap panels -->
<div class="hm-wrap" id="hc">
  <div class="empty"><h2>Load GEX Data</h2><p>Click <code>üìÇ Load JSON</code> to open a gex_data.json file, or <code>üß™ Sample</code> for demo data.</p></div>
</div>

<script>
let D=null;

// ‚ïê‚ïê‚ïê COLOR FUNCTIONS ‚ïê‚ïê‚ïê
// Continuous gradient: yellow (strong +) ‚Üí teal (weak) ‚Üí purple (strong ‚àí)
function gc(n,m,k){
  if(k)return{r:245,g:158,b:11,a:.75};
  const r=n/m,a=Math.abs(r);
  if(a<.03)return{r:34,g:160,b:120,a:.25+a*3};
  if(r>0){const t=Math.min(a,1);return{r:Math.round(34+(251-34)*t),g:Math.round(160+(191-160)*t),b:Math.round(120+(36-120)*t),a:.22+t*.55}}
  const t=Math.min(a,1);return{r:Math.round(34+(130-34)*t),g:Math.round(160+(60-160)*t),b:Math.round(120+(220-120)*t),a:.22+t*.55};
}
function tc(n,m,k){if(k)return'#fde68a';const r=n/m;if(Math.abs(r)<.03)return'#86efac';return r>0?'#fde68a':'#d8b4fe'}
function ct(n,m){const r=n/m;if(Math.abs(r)<.08)return'neutral';return r>0?'positive':'negative'}
function bh(c,k){if(k)return'<strong>‚òÖ King</strong> ‚Äî Max Gamma Activity ¬∑ Price Magnet';if(c==='positive')return'<strong>+Gamma</strong> ‚Äî Dealers Short ¬∑ Mean Reversion ¬∑ Vol‚Üì';if(c==='negative')return'<strong>‚àíGamma</strong> ‚Äî Dealers Long ¬∑ Momentum ¬∑ Vol‚Üë';return'<strong>Neutral</strong> ‚Äî Balanced ¬∑ Choppy'}
function fg(v){const a=Math.abs(v);const s=v<0?'-':'';if(a>=1e9)return s+'$'+(a/1e9).toFixed(1)+'B';if(a>=1e6)return s+'$'+(a/1e6).toFixed(1)+'M';if(a>=1e3)return s+'$'+(a/1e3).toFixed(1)+'K';return s+'$'+a.toFixed(0)}
function fp(p){return p>=1000?p.toFixed(0):p.toFixed(2)}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STRATEGY ENGINE ‚Äî 0DTE focused, GEX-validated, $ premium estimates
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateStrategy(d) {
  const {symbol, spot, strikes, total_net_gex} = d;
  if (!strikes || !strikes.length) return null;

  const mx = Math.max(...strikes.map(s=>Math.abs(s.net_gex)),1);
  // King = max TOTAL gamma activity (call + abs(put)), not net
  const king = strikes.reduce((b,s)=>(s.total_gamma||0)>(b.total_gamma||0)?s:b);
  const gw = strikes.reduce((b,s)=>s.net_gex>b.net_gex?s:b);
  const pw = strikes.reduce((b,s)=>s.net_gex<b.net_gex?s:b);

  const posAbove = strikes.filter(s=>s.strike>spot&&s.net_gex>mx*.12).sort((a,b)=>a.strike-b.strike);
  const posBelow = strikes.filter(s=>s.strike<spot&&s.net_gex>mx*.12).sort((a,b)=>b.strike-a.strike);
  const negAbove = strikes.filter(s=>s.strike>spot&&s.net_gex<-mx*.12).sort((a,b)=>a.strike-b.strike);
  const negBelow = strikes.filter(s=>s.strike<spot&&s.net_gex<-mx*.12).sort((a,b)=>b.strike-a.strike);

  const profile = total_net_gex>mx*.1?'positive':total_net_gex<-mx*.1?'negative':'neutral';
  const kd = king.strike - spot;
  const kdPct = (kd/spot)*100;

  const sorted = [...strikes].sort((a,b)=>a.strike-b.strike);
  const step = sorted.length>=2 ? sorted[1].strike - sorted[0].strike : 5;
  const rnd = v => Math.round(v/step)*step;
  const WING = 10;

  function getDeltaStrike(direction, targetDelta) {
    const spxPts = {0.05:40, 0.10:25, 0.16:18, 0.20:12, 0.30:7};
    const etfPct = {0.05:0.008, 0.10:0.005, 0.16:0.0035, 0.20:0.0025, 0.30:0.0012};
    let offset = symbol==='SPX' ? (spxPts[targetDelta]||18) : spot*(etfPct[targetDelta]||0.0035);
    return rnd(direction==='call' ? spot+offset : spot-offset);
  }

  function gexValidate(strike, direction) {
    const nearest = sorted.reduce((b,s) => Math.abs(s.strike-strike)<Math.abs(b.strike-strike)?s:b);
    const gexRatio = nearest.net_gex / mx;
    let tag='', tagCls='sp', confidence='STANDARD', adjusted=strike;

    if (gexRatio > 0.15) {
      tag='+Gamma Wall'; tagCls='gw'; confidence='HIGH';
      adjusted=nearest.strike;
    } else if (gexRatio < -0.15) {
      const candidates = direction==='put'
        ? sorted.filter(s=>s.strike<spot&&s.net_gex>mx*0.10).sort((a,b)=>b.strike-a.strike)
        : sorted.filter(s=>s.strike>spot&&s.net_gex>mx*0.10).sort((a,b)=>a.strike-b.strike);
      if (candidates.length) {
        adjusted=candidates[0].strike; tag='+Gamma (shifted)'; tagCls='gw'; confidence='HIGH (adjusted)';
      } else { tag='‚ö† ‚àíGamma Zone'; tagCls='pw'; confidence='LOW'; }
    } else {
      tag=`~${(Math.abs(strike-spot)/spot*100).toFixed(2)}% OTM`; tagCls='sp';
    }
    if (Math.abs(adjusted-king.strike)<=step) { tag+=' (near ‚òÖ King)'; tagCls='kn'; }
    return {strike:adjusted, tag, tagCls, confidence, originalDelta:strike};
  }

  // ‚îÄ‚îÄ‚îÄ Premium estimation from live chain data ‚îÄ‚îÄ‚îÄ
  function estimatePremium(strike, type) {
    const s = sorted.reduce((b,c)=>Math.abs(c.strike-strike)<Math.abs(b.strike-strike)?c:b);
    if (type==='call') {
      const bid=s.call_bid||0, ask=s.call_ask||0;
      if (bid>0 && ask>0) return `$${bid.toFixed(2)}‚Äì$${ask.toFixed(2)}`;
      if (ask>0) return `~$${ask.toFixed(2)}`;
    } else {
      const bid=s.put_bid||0, ask=s.put_ask||0;
      if (bid>0 && ask>0) return `$${bid.toFixed(2)}‚Äì$${ask.toFixed(2)}`;
      if (ask>0) return `~$${ask.toFixed(2)}`;
    }
    return null;
  }

  function estimateSpreadCredit(shortStrike, longStrike, shortType) {
    const shortP = estimatePremium(shortStrike, shortType);
    const longP = estimatePremium(longStrike, shortType);
    // Also estimate IC total from short legs
    const sNearest = sorted.reduce((b,c)=>Math.abs(c.strike-shortStrike)<Math.abs(b.strike-shortStrike)?c:b);
    const shortMid = shortType==='put'
      ? ((sNearest.put_bid||0)+(sNearest.put_ask||0))/2
      : ((sNearest.call_bid||0)+(sNearest.call_ask||0))/2;
    const lNearest = sorted.reduce((b,c)=>Math.abs(c.strike-longStrike)<Math.abs(b.strike-longStrike)?c:b);
    const longMid = shortType==='put'
      ? ((lNearest.put_bid||0)+(lNearest.put_ask||0))/2
      : ((lNearest.call_bid||0)+(lNearest.call_ask||0))/2;
    const credit = shortMid - longMid;
    if (credit > 0.05) return `~$${credit.toFixed(2)}/contract ($${(credit*100).toFixed(0)})`;
    return null;
  }

  // ‚îÄ‚îÄ‚îÄ Drift to king commentary ‚îÄ‚îÄ‚îÄ
  function driftCommentary() {
    const dist = Math.abs(kd).toFixed(1);
    const dir = kd>0 ? 'above' : 'below';
    const pct = Math.abs(kdPct).toFixed(2);

    let commentary = `<strong>‚òÖ King at ${fp(king.strike)}</strong> ‚Äî ${dist}pts ${dir} spot (${pct}%). `;

    if (Math.abs(kdPct) < 0.05) {
      commentary += `Spot is sitting ON the king. <em>Strong pin expected.</em> Dealers actively push price back here. Ideal for iron condors/butterflies centered at ${fp(king.strike)}.`;
    } else if (Math.abs(kdPct) < 0.15) {
      commentary += kd > 0
        ? `Slight upward magnet pull. Expect slow drift higher during the session. Dips toward ${fp(spot)} likely bought. Bias: <em>buy dips, sell at king.</em>`
        : `Slight downward magnet pull. Expect slow drift lower. Rallies from ${fp(spot)} likely sold. Bias: <em>sell rips, cover at king.</em>`;
    } else {
      commentary += kd > 0
        ? `Strong upward gravity. Price wants to reach ${fp(king.strike)}. Breakouts above current level carry momentum. Bias: <em>bullish ‚Äî buy calls or call spreads targeting king.</em>`
        : `Strong downward gravity. Price wants to reach ${fp(king.strike)}. Breakdowns below current level carry momentum. Bias: <em>bearish ‚Äî buy puts or put spreads targeting king.</em>`;
    }

    // Add support/resistance context
    if (posAbove[0] && posBelow[0]) {
      commentary += ` <strong>Range:</strong> ${fp(posBelow[0].strike)}‚Äì${fp(posAbove[0].strike)} (+gamma boundaries). `;
      commentary += `Breaks above ${fp(posAbove[0].strike)} or below ${fp(posBelow[0].strike)} change the thesis.`;
    }

    return commentary;
  }

  let strategies = [];

  // ‚ïê‚ïê‚ïê +GAMMA ‚Üí SELL PREMIUM ‚ïê‚ïê‚ïê
  if (profile === 'positive') {
    const rawShortPut = getDeltaStrike('put', 0.16);
    const rawShortCall = getDeltaStrike('call', 0.16);
    const valPut = gexValidate(rawShortPut, 'put');
    const valCall = gexValidate(rawShortCall, 'call');
    const shortPut = valPut.strike, shortCall = valCall.strike;
    const longPut = shortPut - WING, longCall = shortCall + WING;

    // Estimate IC premium from live data
    const putLegCredit = estimateSpreadCredit(shortPut, longPut, 'put');
    const callLegCredit = estimateSpreadCredit(shortCall, longCall, 'call');
    const sPut = sorted.reduce((b,c)=>Math.abs(c.strike-shortPut)<Math.abs(b.strike-shortPut)?c:b);
    const sCall = sorted.reduce((b,c)=>Math.abs(c.strike-shortCall)<Math.abs(b.strike-shortCall)?c:b);
    const putMid = ((sPut.put_bid||0)+(sPut.put_ask||0))/2;
    const callMid = ((sCall.call_bid||0)+(sCall.call_ask||0))/2;
    const lpNearest = sorted.reduce((b,c)=>Math.abs(c.strike-longPut)<Math.abs(b.strike-longPut)?c:b);
    const lcNearest = sorted.reduce((b,c)=>Math.abs(c.strike-longCall)<Math.abs(b.strike-longCall)?c:b);
    const putWingMid = ((lpNearest.put_bid||0)+(lpNearest.put_ask||0))/2;
    const callWingMid = ((lcNearest.call_bid||0)+(lcNearest.call_ask||0))/2;
    const totalCredit = (putMid-putWingMid)+(callMid-callWingMid);
    let premiumEst = totalCredit > 0.10
      ? `~$${totalCredit.toFixed(2)}/contract ($${(totalCredit*100).toFixed(0)} per IC)`
      : `Target ‚Öì of $${WING} wing ¬∑ Verify on chain`;

    let skewNote = '';
    if (kd > spot*0.001) skewNote = 'King above ‚Üí bullish lean. Could tighten call side to 20Œî.';
    else if (kd < -spot*0.001) skewNote = 'King below ‚Üí bearish lean. Could tighten put side to 20Œî.';

    strategies.push({
      name: 'Iron Condor', type: 'ic',
      rationale: `16Œî shorts, $${WING} wings. +Gamma = dealers dampen vol. GEX validates strikes.`,
      legs: [
        {action:'BUY',type:'PUT',strike:longPut,tag:`Wing ($${WING})`,tagCls:'sp'},
        {action:'SELL',type:'PUT',strike:shortPut,tag:valPut.tag,tagCls:valPut.tagCls,note:shortPut!==valPut.originalDelta?`(shifted from ${fp(valPut.originalDelta)})`:'(~16Œî)'},
        {action:'SELL',type:'CALL',strike:shortCall,tag:valCall.tag,tagCls:valCall.tagCls,note:shortCall!==valCall.originalDelta?`(shifted from ${fp(valCall.originalDelta)})`:'(~16Œî)'},
        {action:'BUY',type:'CALL',strike:longCall,tag:`Wing ($${WING})`,tagCls:'sp'},
      ],
      expectedPremium: premiumEst,
      maxProfit: totalCredit>0.10 ? `$${(totalCredit*100).toFixed(0)} (if both sides expire OTM)` : 'Net credit received',
      maxRisk: totalCredit>0.10 ? `$${((WING-totalCredit)*100).toFixed(0)} per spread` : `$${WING*100} per spread minus credit`,
      target: `Stay between ${fp(shortPut)} ‚Äì ${fp(shortCall)}`,
      why: [
        driftCommentary(),
        `<strong>Short put ${fp(shortPut)}:</strong> ${valPut.confidence}. ${valPut.tagCls==='gw'?'Dealers actively defend ‚Äî dips get bought back. Your short has a bodyguard.':'Acceptable positioning.'}${putLegCredit?' Est: '+putLegCredit:''}`,
        `<strong>Short call ${fp(shortCall)}:</strong> ${valCall.confidence}. ${valCall.tagCls==='gw'?'Dealers cap rallies ‚Äî natural resistance. Protected short.':'Acceptable positioning.'}${callLegCredit?' Est: '+callLegCredit:''}`,
        skewNote ? `<strong>Skew:</strong> ${skewNote}` : '',
        `<strong>Mgmt:</strong> Stop each side = total credit. Take profit at 50%. Close 15min before bell.`,
      ].filter(Boolean),
    });

    // ‚îÄ‚îÄ‚îÄ Naked/single leg: SELL PUT (bullish lean) ‚îÄ‚îÄ‚îÄ
    if (kd >= 0 && posBelow[0]) {
      const nakedStrike = posBelow[0].strike;
      const nkP = estimatePremium(nakedStrike, 'put');
      strategies.push({
        name: 'Sell Put (Cash Secured)', type: 'cs',
        rationale: `King above + strong +gamma support at ${fp(nakedStrike)}. Dealers defend this floor ‚Äî sell premium into their protection.`,
        legs: [{action:'SELL',type:'PUT',strike:nakedStrike,tag:'+Gamma Support',tagCls:'gw',note:'(~20-25Œî)'}],
        expectedPremium: nkP || 'Check chain',
        maxProfit: 'Credit received', maxRisk: `Assignment at ${fp(nakedStrike)} minus credit`,
        target: `Hold above ${fp(nakedStrike)}`,
        why: [
          driftCommentary(),
          `<strong>Why this strike:</strong> ${fp(nakedStrike)} is the nearest +gamma wall below spot. Dealers are net short options here ‚Äî they buy dips, creating a floor. ${nkP?'Live est: '+nkP:''}`,
          `<strong>Mgmt:</strong> Close at 50% profit. Roll down/out if delta hits 40+. This is a <em>defined-risk alternative to naked puts</em> if used cash-secured.`,
        ],
      });
    }

    // ‚îÄ‚îÄ‚îÄ BUY CALL (directional, king above) ‚îÄ‚îÄ‚îÄ
    if (kd > spot * 0.001) {
      const callStrike = rnd(spot);
      const cP = estimatePremium(callStrike, 'call');
      strategies.push({
        name: 'Buy ATM Call', type: 'ds',
        rationale: `King at ${fp(king.strike)} above spot = upward magnet. +Gamma = controlled drift (not violent). ATM call captures the move.`,
        legs: [{action:'BUY',type:'CALL',strike:callStrike,tag:'ATM',tagCls:'sp',note:'(~50Œî)'}],
        expectedPremium: cP ? `Cost: ${cP}` : 'Check chain',
        maxProfit: 'Unlimited', maxRisk: 'Premium paid',
        target: `Rally to ${fp(king.strike)} (king magnet)`,
        why: [
          driftCommentary(),
          `<strong>Why naked call:</strong> Simpler than a spread when you have high conviction on king drift. +Gamma means the move is slow & steady, not a violent spike ‚Äî theta-friendly if you enter early.${cP?' Live est: '+cP:''}`,
          `<strong>Mgmt:</strong> Take profit at 50-100% gain on premium. Cut at 50% loss. Best entered AM when theta decay is slowest.`,
        ],
      });
    }

    // ‚îÄ‚îÄ‚îÄ Butterfly (0DTE pin) ‚îÄ‚îÄ‚îÄ
    if (Math.abs(kdPct) < 0.2) {
      const center = rnd(king.strike);
      strategies.push({
        name: 'Butterfly (Pin Play)', type: 'bf',
        rationale: `King near spot + +gamma = high pin probability. Lottery ticket.`,
        legs: [
          {action:'BUY',type:'CALL',strike:center-WING,tag:'Lower wing',tagCls:'sp'},
          {action:'SELL',type:'CALL',strike:center,tag:'‚òÖ King center',tagCls:'kn',qty:2},
          {action:'BUY',type:'CALL',strike:center+WING,tag:'Upper wing',tagCls:'sp'},
        ],
        expectedPremium: '~$1-$3 debit ¬∑ Enter after 2pm',
        maxProfit: `$${WING*100} minus debit`, maxRisk: 'Debit paid',
        target: `Pin at ${fp(center)}`,
        why: [
          `‚òÖ King at ${fp(center)} = strongest magnet. +Gamma pushes price here. Best after 2pm when theta accelerates.`,
          `<strong>Sizing:</strong> Small position ‚Äî lottery ticket, not core trade.`,
        ],
      });
    }
  }

  // ‚ïê‚ïê‚ïê ‚àíGAMMA ‚Üí DIRECTIONAL ‚ïê‚ïê‚ïê
  else if (profile === 'negative') {
    if (kd > 0) {
      // ‚îÄ‚îÄ‚îÄ Call Debit Spread (bullish) ‚îÄ‚îÄ‚îÄ
      const longCall = rnd(spot);
      const shortCall = rnd(Math.min(king.strike, spot + step*6));
      const lP = estimatePremium(longCall, 'call');
      strategies.push({
        name: 'Call Debit Spread', type: 'ds',
        rationale: `‚àíGamma + king ABOVE = dealers amplify upward moves. Buy direction.`,
        legs: [
          {action:'BUY',type:'CALL',strike:longCall,tag:'ATM',tagCls:'sp',note:'(~50Œî)'},
          {action:'SELL',type:'CALL',strike:shortCall,tag:'Near king',tagCls:'kn'},
        ],
        expectedPremium: `~40-55% of width ¬∑ ${lP?'ATM call: '+lP:'Verify on chain'}`,
        maxProfit: `$${((shortCall-longCall)*100)}`, maxRisk: 'Debit paid',
        target: `Rally to ${fp(king.strike)}`,
        why: [
          driftCommentary(),
          `<strong>Why NOT sell premium:</strong> <span class="pur">‚àíGamma = dealers hedge WITH the move.</span> Selling ICs into ‚àígamma = getting run over. Buy direction instead.`,
          `<strong>Mgmt:</strong> Take profit at 50-75%. Cut at 50% debit loss.`,
        ],
      });

      // ‚îÄ‚îÄ‚îÄ BUY CALL (naked directional) ‚îÄ‚îÄ‚îÄ
      const cP = estimatePremium(rnd(spot), 'call');
      strategies.push({
        name: 'Buy Call (Momentum)', type: 'ds',
        rationale: `‚àíGamma amplifies moves. King above = bullish gravity. Naked call for maximum upside.`,
        legs: [{action:'BUY',type:'CALL',strike:rnd(spot),tag:'ATM',tagCls:'sp',note:'(~50Œî)'}],
        expectedPremium: cP ? `Cost: ${cP}` : 'Check chain',
        maxProfit: 'Unlimited', maxRisk: 'Premium paid',
        target: `Rally to ${fp(king.strike)}+`,
        why: [
          driftCommentary(),
          `<strong>Why naked call over spread:</strong> ‚àíGamma moves can be violent. Spreads cap your upside. If conviction is high, naked call captures the full breakout.${cP?' Cost: '+cP:''}`,
          `<strong>Mgmt:</strong> Trail stop at 50% of gains. Cut at 50% premium loss.`,
        ],
      });
    } else if (kd < 0) {
      // ‚îÄ‚îÄ‚îÄ Put Debit Spread (bearish) ‚îÄ‚îÄ‚îÄ
      const longPut = rnd(spot);
      const shortPut = rnd(Math.max(king.strike, spot - step*6));
      const lP = estimatePremium(longPut, 'put');
      strategies.push({
        name: 'Put Debit Spread', type: 'ds',
        rationale: `‚àíGamma + king BELOW = dealers amplify downward moves. Buy direction.`,
        legs: [
          {action:'BUY',type:'PUT',strike:longPut,tag:'ATM',tagCls:'sp',note:'(~50Œî)'},
          {action:'SELL',type:'PUT',strike:shortPut,tag:'Near king',tagCls:'kn'},
        ],
        expectedPremium: lP ? `ATM put: ${lP}` : 'Verify on chain',
        maxProfit: `$${((longPut-shortPut)*100)}`, maxRisk: 'Debit paid',
        target: `Drop to ${fp(king.strike)}`,
        why: [driftCommentary(), `<strong>Mgmt:</strong> Take profit at 50-75%. Cut at 50% debit loss.`],
      });

      // ‚îÄ‚îÄ‚îÄ BUY PUT (naked directional) ‚îÄ‚îÄ‚îÄ
      const pP = estimatePremium(rnd(spot), 'put');
      strategies.push({
        name: 'Buy Put (Momentum)', type: 'ds',
        rationale: `‚àíGamma + king below = bearish gravity. Naked put for max downside capture.`,
        legs: [{action:'BUY',type:'PUT',strike:rnd(spot),tag:'ATM',tagCls:'sp',note:'(~50Œî)'}],
        expectedPremium: pP ? `Cost: ${pP}` : 'Check chain',
        maxProfit: 'Substantial', maxRisk: 'Premium paid',
        target: `Drop to ${fp(king.strike)}+`,
        why: [driftCommentary(), `<strong>Mgmt:</strong> Trail stop at 50% gains. Cut at 50% premium loss.`],
      });
    }
  }

  // ‚ïê‚ïê‚ïê NEUTRAL ‚Üí CAUTIOUS ‚ïê‚ïê‚ïê
  else {
    const center = rnd(king.strike);
    strategies.push({
      name: 'Iron Butterfly (¬Ω Size)', type: 'bf',
      rationale: `Neutral = no edge. King at ${fp(center)} is weak magnet. Sell for theta, reduce size.`,
      legs: [
        {action:'BUY',type:'PUT',strike:center-WING,tag:'Put wing',tagCls:'sp'},
        {action:'SELL',type:'PUT',strike:center,tag:'‚òÖ King',tagCls:'kn'},
        {action:'SELL',type:'CALL',strike:center,tag:'‚òÖ King',tagCls:'kn'},
        {action:'BUY',type:'CALL',strike:center+WING,tag:'Call wing',tagCls:'sp'},
      ],
      expectedPremium: `~$5-$8 ATM ¬∑ Verify`, maxProfit: 'Credit received',
      maxRisk: `$${WING*100} minus credit`, target: `Pin at ${fp(center)}`,
      why: [
        driftCommentary(),
        `<strong>Neutral gamma = chop.</strong> No directional edge. Sell theta but size down 50%. Can flip direction without warning.`,
        `<strong>Mgmt:</strong> Take profit at 25%. Stop at 1√ó credit loss.`,
      ],
    });

    // ‚îÄ‚îÄ‚îÄ Straddle sell for theta ‚îÄ‚îÄ‚îÄ
    strategies.push({
      name: 'Sell Straddle (¬Ω Size)', type: 'ic',
      rationale: `Neutral gamma = expect chop around ${fp(center)}. Sell ATM straddle for max theta, small size.`,
      legs: [
        {action:'SELL',type:'PUT',strike:center,tag:'‚òÖ King ATM',tagCls:'kn'},
        {action:'SELL',type:'CALL',strike:center,tag:'‚òÖ King ATM',tagCls:'kn'},
      ],
      expectedPremium: 'Check chain (ATM straddle)', maxProfit: 'Credit received',
      maxRisk: 'Unlimited ‚Äî use stops', target: `Pin at ${fp(center)}`,
      why: [`Maximum theta at ${fp(center)}. <strong>Half size, tight stops.</strong> Neutral gamma can break either way.`],
    });
  }

  return strategies;
}

// ‚ïê‚ïê‚ïê STRATEGY TOGGLE & RENDER ‚ïê‚ïê‚ïê
let stratVisible = false;
function toggleStrats() {
  stratVisible = !stratVisible;
  const sw = document.getElementById('sw');
  const btn = document.getElementById('stratBtn');
  if (stratVisible) { sw.classList.add('vis'); btn.textContent='üìä Strategy ‚ñ¥'; renderStrats(); }
  else { sw.classList.remove('vis'); btn.textContent='üìä Strategy ‚ñæ'; }
}

function renderStrats() {
  const sw = document.getElementById('sw');
  if (!D) { sw.classList.remove('vis'); return; }
  sw.innerHTML = '';
  if (!stratVisible) return;
  sw.classList.add('vis');

  const syms = Object.keys(D).sort((a,b)=>a==='SPX'?-1:b==='SPX'?1:0);
  syms.forEach(sym => {
    const symData = D[sym]; if (!symData) return;
    const strats = generateStrategy(symData);
    if (!strats || !strats.length) return;
    const s = strats[0];
    const card = document.createElement('div'); card.className='strat-card';
    const legsHtml = s.legs.map(l => `
      <div class="strat-leg">
        <span class="strat-leg-action ${l.action.toLowerCase()}">${l.action}</span>
        <span class="strat-leg-type">${l.type}</span>
        <span class="strat-leg-strike">${fp(l.strike)}${l.qty?' √ó'+l.qty:''}${l.note?' <span style="color:var(--dim);font-size:9px">'+l.note+'</span>':''}</span>
        <span class="strat-leg-tag ${l.tagCls}">${l.tag}</span>
      </div>`).join('');
    const whyHtml = s.why.map(w=>`<div style="margin:4px 0">‚Üí ${w}</div>`).join('');
    let altHtml = '';
    if (strats.length > 1) {
      altHtml = '<div style="padding:8px 16px;border-top:1px solid var(--border);font-size:9px;color:var(--dim)"><strong style="color:var(--text)">Alt:</strong> '+
        strats.slice(1).map(a=>`<span style="margin-left:6px;padding:2px 6px;background:rgba(255,255,255,.03);border-radius:3px;cursor:pointer" onclick="showAlt(this,\'${sym}\',${strats.indexOf(a)})">${a.name}</span>`).join('')+'</div>';
    }
    card.innerHTML = `
      <div class="strat-hdr"><span class="strat-sym">${sym} ¬∑ $${fp(symData.spot)}</span><span class="strat-type-badge ${s.type}">${s.name}</span></div>
      <div class="strat-body">
        <div class="strat-rationale">${s.rationale}</div>
        <div class="strat-legs"><div class="strat-legs-title">Legs</div>${legsHtml}</div>
        <div class="strat-details">
          <div class="strat-detail"><div class="strat-detail-label">Premium Est.</div><div class="strat-detail-val" style="color:var(--cyan);font-size:10px">${s.expectedPremium||'‚Äî'}</div></div>
          <div class="strat-detail"><div class="strat-detail-label">Max Profit</div><div class="strat-detail-val profit">${s.maxProfit}</div></div>
          <div class="strat-detail"><div class="strat-detail-label">Max Risk</div><div class="strat-detail-val risk">${s.maxRisk}</div></div>
          <div class="strat-detail"><div class="strat-detail-label">Target</div><div class="strat-detail-val">${s.target}</div></div>
        </div>
        <div class="strat-why">${whyHtml}</div>
      </div>
      ${altHtml}
      <div class="strat-disclaimer">‚ö† Not financial advice. Verify on live chain.</div>`;
    sw.appendChild(card);
  });

  // Confluence
  if (syms.length>=3) {
    const profiles = syms.map(sym=>{const d=D[sym];const mx2=Math.max(...d.strikes.map(s=>Math.abs(s.net_gex)),1);return d.total_net_gex>mx2*.1?'positive':d.total_net_gex<-mx2*.1?'negative':'neutral'});
    const p0=profiles[0]; const allAgree=profiles.every(p=>p===p0);
    const confCard = document.createElement('div');
    confCard.style.cssText='width:100%;padding:8px 12px;border-radius:6px;font-size:10px;margin-top:4px';
    if (allAgree) { confCard.style.background='rgba(34,197,94,.08)'; confCard.style.color='var(--green)'; confCard.innerHTML=`‚úÖ <strong>Full confluence</strong> ‚Äî All symbols confirm ${p0} gamma.`; }
    else { confCard.style.background='rgba(251,191,36,.08)'; confCard.style.color='var(--yellow)'; confCard.innerHTML=`‚ö† <strong>Mixed signals</strong> ‚Äî Symbols disagree. Reduce size.`; }
    sw.appendChild(confCard);
  }
}

// ‚îÄ‚îÄ‚îÄ Recs ‚îÄ‚îÄ‚îÄ
function genRec(d){
  const {spot,strikes,total_net_gex}=d;
  if(!strikes||!strikes.length)return{summary:'No data',bias:'neutral',action_items:[]};
  const mx=Math.max(...strikes.map(s=>Math.abs(s.net_gex)),1);
  const king=strikes.reduce((b,s)=>(s.total_gamma||0)>(b.total_gamma||0)?s:b);
  const posA=strikes.filter(s=>s.strike>spot&&s.net_gex>mx*.15).sort((a,b)=>a.strike-b.strike);
  const posB=strikes.filter(s=>s.strike<spot&&s.net_gex>mx*.15).sort((a,b)=>b.strike-a.strike);
  const profile=total_net_gex>mx*.1?'positive':total_net_gex<-mx*.1?'negative':'neutral';
  const bias=profile==='positive'?'range':profile==='negative'?'trend':'chop';
  const kd=king.strike-spot,kp=(kd/spot)*100;
  const items=[];
  if(Math.abs(kp)>.02)items.push(`DRIFT TARGET: ${king.strike.toFixed(1)} (${kd>0?'above':'below'})`);
  else items.push(`PIN ZONE: ${king.strike.toFixed(1)}`);
  if(posB[0])items.push(`SUPPORT: ${posB[0].strike.toFixed(1)}`);
  if(posA[0])items.push(`RESISTANCE: ${posA[0].strike.toFixed(1)}`);
  const hi=posA[0]?.strike||(kd>0?king.strike:spot+20),lo=posB[0]?.strike||(kd<0?king.strike:spot-20);
  let summary;
  if(profile==='positive'&&Math.abs(kp)<.15)summary=`PIN & CHOP ‚Äî King ${king.strike.toFixed(1)}. Fade ${lo.toFixed(1)}‚Äì${hi.toFixed(1)}.`;
  else if(profile==='positive')summary=`DRIFT TO KING ‚Äî Magnet ${king.strike.toFixed(1)}. Range ${lo.toFixed(1)}‚Äì${hi.toFixed(1)}.`;
  else if(profile==='negative'&&kd>0)summary=`BULLISH MOMENTUM ‚Äî King UP to ${king.strike.toFixed(1)}.`;
  else if(profile==='negative'&&kd<0)summary=`BEARISH MOMENTUM ‚Äî King DOWN to ${king.strike.toFixed(1)}.`;
  else summary=`CHOPPY ‚Äî King ${king.strike.toFixed(1)}. Wait.`;
  return{summary,bias,king_node:{strike:king.strike},expected_range:{low:lo,high:hi},action_items:items};
}

function renderRecs(){
  const rw=document.getElementById('rw');
  if(!D){rw.classList.remove('vis');return}
  rw.innerHTML='';rw.classList.add('vis');
  Object.keys(D).forEach(sym=>{
    const d=D[sym];const r=d.recommendation||genRec(d);
    const c=document.createElement('div');c.className=`rec ${r.bias||'chop'}`;
    c.innerHTML=`
      <div class="rec-sym">${sym} $${fp(d.spot)} <span class="rec-badge ${r.bias}">${(r.bias||'?').toUpperCase()}</span></div>
      <div class="rec-sum">${r.summary||''}</div>
      <div>${(r.action_items||[]).map(i=>`<div class="rec-act"><span>${i.includes('‚Üë')?'üü£':i.includes('‚Üì')?'üü£':i.includes('SUPPORT')?'üü°':i.includes('RESIST')?'üü°':'‚òÖ'}</span>${i}</div>`).join('')}</div>
      <div class="rec-lvls">
        <span class="rec-lv king">‚òÖ King: ${fp(r.king_node?.strike||0)}</span>
        ${r.expected_range?`<span class="rec-lv rng">Range: ${fp(r.expected_range.low)}‚Äì${fp(r.expected_range.high)}</span>`:''}
      </div>`;
    rw.appendChild(c);
  });
}

// ‚îÄ‚îÄ‚îÄ Heatmap panel ‚îÄ‚îÄ‚îÄ
function renderPanel(d){
  const {symbol,spot,strikes,total_net_gex,gamma_wall,put_wall}=d;
  const n=+document.getElementById('ns').value;
  const sorted=[...strikes].sort((a,b)=>a.strike-b.strike);
  if(!sorted.length)return document.createElement('div');
  const ci=sorted.reduce((b,s,i)=>Math.abs(s.strike-spot)<Math.abs(sorted[b].strike-spot)?i:b,0);
  const vis=sorted.slice(Math.max(0,ci-n),Math.min(sorted.length,ci+n+1)).reverse();
  const mx=Math.max(...vis.map(s=>Math.abs(s.net_gex)),1);
  const ss=sorted[ci]?.strike;
  // King = max total gamma activity
  const ks=vis.reduce((b,s)=>(s.total_gamma||Math.abs(s.net_gex))>(b.total_gamma||Math.abs(b.net_gex))?s:b).strike;
  const pc=total_net_gex>mx*.05?'pos':total_net_gex<-mx*.05?'neg':'neu';
  const pl=pc==='pos'?'+Gamma':pc==='neg'?'‚àíGamma':'Neutral';
  const pd=pc==='pos'?'Vol‚Üì Mean reversion':pc==='neg'?'Vol‚Üë Momentum':'Choppy';

  // King distance info
  const kingDist = ks - spot;
  const kingPct = ((kingDist/spot)*100).toFixed(2);
  const kingDir = kingDist>0 ? '‚Üë' : kingDist<0 ? '‚Üì' : '‚óè';

  const p=document.createElement('div');p.className='panel';
  p.innerHTML=`
    <div class="panel-hdr"><span class="panel-sym">${symbol}</span><span class="panel-price">$${fp(spot)}</span></div>
    <div class="panel-sub"><span>Net GEX: ${fg(total_net_gex)}</span><span>${d.expirations?d.expirations.length+' exp':''}</span></div>
    <div class="panel-gp"><span class="gbadge ${pc}">${pl}</span><span style="font-size:9px;color:var(--dim)">${pd}</span></div>
    <div class="klevels">
      <span class="klev kn">‚òÖ ${fp(ks)}</span>
      <span class="klev gw">Œì ${fp(gamma_wall)}</span>
      <span class="klev pw">P ${fp(put_wall)}</span>
      <span class="klev sp">‚óè ${fp(spot)}</span>
    </div>
    <div style="padding:2px 14px;font-size:8px;color:var(--king);border-bottom:1px solid var(--border)">
      ${kingDir} $${Math.abs(kingDist).toFixed(2)} (${kingPct}%) ${kingDist>0?'above':'below'} spot
    </div>
    <div class="strikes" id="s-${symbol}"></div>`;
  const cont=p.querySelector(`#s-${symbol}`);
  vis.forEach(s=>{
    const iS=s.strike===ss,iK=s.strike===ks;
    const co=gc(s.net_gex,mx,iK);const tco=tc(s.net_gex,mx,iK);
    const intensity = Math.min(1, Math.abs(s.net_gex)/mx);
    const bgA = 0.15 + intensity * 0.6;
    const row=document.createElement('div');row.className='sr'+(iS?' spot':'')+(iK?' king':'');
    row.innerHTML=`<div class="sr-bg" style="background:rgba(${co.r},${co.g},${co.b},${bgA})"></div><span class="sr-lbl">${fp(s.strike)}</span><div class="gbar-c"><span class="gval" style="color:${tco}">${fg(s.net_gex)}${iK?' ‚òÖ':''}</span></div>`;
    row.onmouseenter=e=>showTip(e,s,symbol,spot,mx,iK);row.onmousemove=moveTip;row.onmouseleave=hideTip;
    cont.appendChild(row);
  });
  return p;
}

function showTip(e,s,sym,spot,mx,iK){const t=document.getElementById('tip');const d=s.strike-spot,c=ct(s.net_gex,mx);document.getElementById('tt').textContent=(iK?'‚òÖ ':'')+sym+' ‚Äî $'+fp(s.strike);document.getElementById('tb').innerHTML=`<div class="tip-r"><span class="tip-l">Net GEX</span><span class="tip-v">${fg(s.net_gex)}</span></div><div class="tip-r"><span class="tip-l">Call GEX</span><span class="tip-v" style="color:#fde68a">${fg(s.call_gex)}</span></div><div class="tip-r"><span class="tip-l">Put GEX</span><span class="tip-v" style="color:#d8b4fe">${fg(s.put_gex)}</span></div><div class="tip-d"></div><div class="tip-r"><span class="tip-l">Call OI</span><span class="tip-v">${(s.call_oi||0).toLocaleString()}</span></div><div class="tip-r"><span class="tip-l">Put OI</span><span class="tip-v">${(s.put_oi||0).toLocaleString()}</span></div>${s.call_bid?`<div class="tip-r"><span class="tip-l">Call Bid/Ask</span><span class="tip-v">$${s.call_bid.toFixed(2)}/$${s.call_ask.toFixed(2)}</span></div>`:''}${s.put_bid?`<div class="tip-r"><span class="tip-l">Put Bid/Ask</span><span class="tip-v">$${s.put_bid.toFixed(2)}/$${s.put_ask.toFixed(2)}</span></div>`:''}<div class="tip-r"><span class="tip-l">From Spot</span><span class="tip-v">${d>=0?'+':''}${d.toFixed(1)} (${((d/spot)*100).toFixed(2)}%)</span></div><div class="tip-d"></div><div class="tip-b">${bh(c,iK)}</div>`;t.classList.add('vis');moveTip(e)}
function moveTip(e){const t=document.getElementById('tip');const x=e.clientX+16,y=e.clientY-10;t.style.left=(x+t.offsetWidth>window.innerWidth?e.clientX-t.offsetWidth-16:x)+'px';t.style.top=(y+t.offsetHeight>window.innerHeight?window.innerHeight-t.offsetHeight-8:y)+'px'}
function hideTip(){document.getElementById('tip').classList.remove('vis')}

function rerender(){if(!D)return;renderRecs();if(stratVisible)renderStrats();const c=document.getElementById('hc');c.innerHTML='';
  const syms = Object.keys(D).sort((a,b)=>a==='SPX'?-1:b==='SPX'?1:0);
  syms.forEach(s=>c.appendChild(renderPanel(D[s])));updateTimestamp()}

function updateTimestamp(){
  const ts = D?.[Object.keys(D)[0]]?.timestamp;
  if(ts){ document.getElementById('st').textContent = `Updated ${new Date(ts).toLocaleTimeString()}`; }
}

// ‚ïê‚ïê‚ïê AUTO-RELOAD ‚ïê‚ïê‚ïê
let autoFile = null, autoInterval = null;
function loadFile(e){ const f=e.target.files[0];if(!f)return; autoFile=f; readAndRender(f); startAutoReload(); }
function readAndRender(f){
  const r=new FileReader();
  r.onload=ev=>{try{
    const newD=JSON.parse(ev.target.result);
    const newTs=newD[Object.keys(newD)[0]]?.timestamp;
    const oldTs=D?.[Object.keys(D||{})[0]]?.timestamp;
    if(newTs!==oldTs||!D){D=newD;document.getElementById('sb').classList.remove('vis');document.getElementById('sd').className='status-dot live';rerender();console.log('GEX updated:',new Date().toLocaleTimeString())}
  }catch(err){console.error('JSON parse error',err)}};
  r.readAsText(f);
}
function startAutoReload(){ if(autoInterval)clearInterval(autoInterval); autoInterval=setInterval(()=>{if(autoFile)readAndRender(autoFile)},30000); document.getElementById('st').textContent='Auto-reload ON (30s)'; }
function stopAutoReload(){ if(autoInterval){clearInterval(autoInterval);autoInterval=null} document.getElementById('st').textContent='Auto-reload OFF'; }

function loadSample(){
  const sp={SPX:6974,SPY:695,QQQ:615,IWM:267};
  D={};
  Object.keys(sp).forEach(sym=>{
    const spot=sp[sym]*(1+(Math.random()-.5)*.002);
    const step=sym==='SPX'?5:1;
    const strikes=[],center=Math.round(spot/step)*step;
    const scale=sym==='SPX'?1:sym==='SPY'?8:sym==='QQQ'?1.5:0.4;
    for(let i=-25;i<=25;i++){
      const strike=center+i*step;let net;
      const decay=Math.exp(-Math.abs(i)*.07);
      if(Math.abs(i)<=1) net=(Math.random()-.4)*15e3*scale;
      else if(i>0){net=12e3*(.05+Math.random()*.5)*decay*scale;if(strike%(step*10)===0)net*=2.5+Math.random()*2}
      else{net=-12e3*(.05+Math.random()*.5)*decay*scale;if(strike%(step*10)===0)net*=2.5+Math.random()*2}
      if(i===-1)net=35e3*scale; // strong below spot like their data
      const cg=Math.abs(net)*(.5+Math.random()*.4);
      const pg=Math.abs(net)*(.3+Math.random()*.3);
      strikes.push({strike,net_gex:net,call_gex:net>0?cg:cg*.3,put_gex:net<0?-pg:-pg*.2,total_gamma:cg+pg,call_oi:~~(Math.random()*12e3+100),put_oi:~~(Math.random()*12e3+100),
        call_bid:Math.max(0,(20-Math.abs(i)*1.2)+Math.random()*2).toFixed(2)*1,call_ask:Math.max(0.05,(20-Math.abs(i)*1.1)+Math.random()*3).toFixed(2)*1,
        put_bid:Math.max(0,(15-Math.abs(i)*1.0)+Math.random()*2).toFixed(2)*1,put_ask:Math.max(0.05,(15-Math.abs(i)*0.9)+Math.random()*3).toFixed(2)*1,
        call_iv:18+Math.random()*8,put_iv:20+Math.random()*10,call_delta:Math.max(0,0.5-i*0.03),put_delta:Math.min(0,-0.5-i*0.03)})
    }
    strikes.sort((a,b)=>a.strike-b.strike);
    const tot=strikes.reduce((s,x)=>s+x.net_gex,0);
    D[sym]={symbol:sym,spot,timestamp:new Date().toISOString(),expirations:['2026-02-10','2026-02-11'],total_net_gex:tot,gamma_wall:strikes.reduce((b,s)=>s.net_gex>b.net_gex?s:b).strike,put_wall:strikes.reduce((b,s)=>s.net_gex<b.net_gex?s:b).strike,king_node:strikes.reduce((b,s)=>s.total_gamma>b.total_gamma?s:b).strike,strikes}
  });
  document.getElementById('sb').classList.add('vis');document.getElementById('sd').className='status-dot live';document.getElementById('st').textContent='Sample (0DTE)';rerender()
}
</script>
</body></html>
